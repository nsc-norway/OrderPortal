{# Accounts list page. #}

{% extends "base.html" %}

{% block head_title %}Accounts{% end %}
{% block body_title %}{% module Icon('account') %} Accounts{% end %}

{% block header_css %}
<link rel="stylesheet" type="text/css"
      href="{{ settings['DATATABLES_CSS_URL'] }}">
{% end %}

{% block container %}
<div class="container-fluid">
{% end %}

{% block body_header_meta %}
<a href="{{ reverse_url('accounts_api', **params) }}">
  {% module Icon('json') %} JSON
</a>
&nbsp;
<a href="{{ reverse_url('accounts_csv', **params) }}">
  {% module Icon('csv') %} CSV
</a>
{% end %}

{% block content %}
<form action="{{ reverse_url('accounts', **params) }}"
      id="refresh"
      role="form" class="form-inline"
      method="GET">

  <div class="row">
    <div class="col-md-10 col-md-offset-2">
      <span class="glyphicon glyphicon-filter"></span>
      <div class="form-group">
	<label for="university">Filter by</label>
	<select name="university" id="university" class="form-control refresh">
	  <option value="">[any university]</option>
	  {% set sel = params.get('university') == '[other]' and 'selected' or '' %}
	  <option value="[other]" {{ sel }}>[other]</option>
	  {# OrderedDict ! #}
	  {% for abbrev, data in settings['UNIVERSITIES'].items() %}
	  {% set sel = abbrev == params.get('university') and 'selected' or '' %}
	  <option {{ sel }} value="{{ abbrev }}">{{ abbrev }} ({{ data.get('name', abbrev) }})</option>
	  {% end %}
	</select>
      </div>
      <div class="form-group">
	<select name="role" id="role" class="form-control refresh">
	  <option value="">[any role]</option>
	  {% for role in constants.ACCOUNT_ROLES %}
	  {% set sel = role == params.get('role') and 'selected' or '' %}
	  <option {{ sel }} value="{{ role }}">{{ role.capitalize() }}</option>
	  {% end %}
	</select>
      </div>
      <div class="form-group">
	<select name="status" id="status" class="form-control refresh">
	  <option value="">[any status]</option>
	  {% for status in constants.ACCOUNT_STATUSES %}
	  {% set sel = status == params.get('status') and 'selected' or '' %}
	  <option {{ sel }} value="{{ status }}">{{ status.capitalize() }}</option>
	  {% end %}
	</select>
      </div>
    </div>
  </div>
</form>

<div class="row">
  <div class="col-md-12">
    <table id="accounts" class="table table-striped table-condensed"
	   data-page-length='25'>
      <thead>
	<tr>
	  <th>Account</th>
	  <th>Name</th>
	  <th>{{ term('Orders') }}</th>
	  <th width="15%">University</th>
	  <th>Role</th>
	  <th>Status</th>
	  <th>Login</th>
	  <th>Modified</th>
	</tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
{% end %}

{% block javascript_code %}
{% import json %}
<script src="{{ settings['DATATABLES_JS_URL'] }}"></script>
<script src="{{ settings['DATATABLES_BOOTSTRAP_JS_URL'] }}"></script>
<script>
$(document).ready(function() {
  $(".refresh").change(function () {
    $("#refresh").submit();
  });
  $("#accounts").DataTable( {
    pagingType: "full_numbers",
    order: [[7, "desc"]],
    ajax: {
      url: "/api/v1/accounts",
      dataSrc: "items",
      data: {% raw json.dumps(params) %}
    },
    columns: [
      {data: "email",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.links.display.href+"'>"+oData.email+"</a>");
       }
      },
      {data: "name"},
      {data: "orders",
       render: function (data, type, full, meta) {
         if (type === 'display') {
           return "<a class='badge' href='"+data.links.display.href+"'>"+
                  data.count+"</a>";
         } else {
           return data.count;
	 }
       }
      },
      {data: "university"},
      {data: "role"},
      {data: "status",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<img src='"+oData.status.image.href+"'> "+oData.status.name);
       }
      },
      {data: "login",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         if (oData.login !== '-') {
           $(nTd).html($.localtime.toLocalTime(oData.login));
         };
       }
      },
      {data: "modified",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html($.localtime.toLocalTime(oData.modified));
       }
      }
    ]
  });
});
</script>
{% end %} {# block javascript_code #}
