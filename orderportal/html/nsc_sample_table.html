{# Sample table page. #}

{% block head_title %}Samples for order '{{ order['title'] }}'{% end %}
{% block body_title %}Samples for order: {{ order['title'] }}{% end %}

{% extends "base.html" %}

{% block header_css %}
<link rel="stylesheet" href="{{ static_url('nsc_style.css') }}">
{% end %}

{% block body_header_meta %}
<a href="{{ reverse_url('order_api', order['_id']) }}">
  {% module Icon('json') %} JSON
</a>
{% end %}

{% block meta_content %}
<form action="{{ reverse_url('order', order['_id']) }}"
role="form"	method="GET">
  <input type="hidden" name="_http_method" value="delete">
  <button type="submit" class="btn btn-danger btn-block">
    <span class="glyphicon glyphicon-trash"></span>
    Cancel
  </button>
</form>

<br>
<br>

{% if valid %}
<form action="{{ reverse_url('order', order['_id']) }}"
  	role="form"
  	method="POST">
  {% module xsrf_form_html() %}
  <p>
    <button type="submit" name="submit" class="btn btn-lg btn-success btn-block">
      <span class="glyphicon glyphicon-trash"></span>
      Save
    </button>
  </p>
</form>
{% else %}
<div class="well well-lg text-danger">
  Upload a valid sample table to save.
</div>
{% end %} {# if targets #}

{% end %} {# block meta_content #}

{% block main_content %}
<div class="panel panel-default">
  <div class="panel-body">
  To enter sample information:
    <ul>
      <li>Download the
    <a href="https://portal.sequencing.uio.no/file/Sample%20table/download">sample table template</a></li>
    <li>Fill in information about your samples and save it</li>
    <li>Upload it in the form below</li>
    <li>Verify the output and click Save on the right</li>
  </ul>


  {% if valid %}
  <p>
    Please confirm that the sample information has been imported correctly, by inspecting the table below.
    If there is an error, contact us at <a href="mailto:post@sequencing.uio.no">post@sequencing.uio.no</a>.
  </p>
  {% else %}
  <p>
  </p>
  {% end %}

  <form action="{{ reverse_url('nsc_order_samples', order['_id']) }}"
        role="form"
        enctype="multipart/form-data"
        method="POST">
    {% module xsrf_form_html() %}
    <label for="file">Sample table (Spreadsheet: Excel or CSV)</label>
    <div style="clear: both;"></div>
    <div class="form-group upload-box">
      <input type="file" name="file" class="form-control">
      <span class="help-block">
        The sample table to upload.
      </span>
    </div>

    <div class="form-group upload-btn-box">
      <label class="control-label"></label>
      <button type="submit" class="btn btn-success" name="upload" value="upload">
        <span class="glyphicon glyphicon-floppy-disk"></span>
        Upload
      </button>
    </div>
  </form>
  <div style="clear: both;"></div>

  {% if messages %}
  <h3>Errors</h3>
  <p>Please correct the following problems:</p>
  <ul>
    {% for message in messages %}
    <li class="form-error">{{ message }}</li>
    {% end %}
  </ul>
  {% end %}{# if messages #}

  <h3>Sample information ({{ len(table) }} samples)</h3>
  <form action="{{ reverse_url('nsc_order_samples', order['_id']) }}"
        fole="form"
        method="POST">
  <div class="the-grid">
  {% module xsrf_form_html() %}

  <table class="sample-list">
    <tr>
    <th></th>
      {% for col in columns %}
      <th>
        {{ col.label }}
      </th>
      {% end %}
    </tr>
    {% for i_row, row in enumerate(table) %}
    <tr>
    <td></td>
      {% for cell in row %}
      <td {{ 'class="validation-error"' if not cell.valid else '' }}>
        {% if not cell.valid %}
        <div class="error-message">{{ cell.message }}</div>
        {% end %}
        <input type="text" name="{{ cell.field.id + "_" + str(i_row) }}"
                size="{{ cell.field.width }}" value="{{ cell.value }}">
      </td>
      {% end %}
    </tr>
    {% end %}
    <tr>
      <td class="input">
        <button type="submit" class="btn btn-success"
           name="add-sample" value="add-sample">
          <span class="glyphicon glyphicon-plus"></span>
          Add
        </button>
      </td>
      {% for col in columns %}
      {% if col.id == 'sample_number' %}
      <td class="input">(new)</td>
      {% else %}
      <td class="input">
        <input type="text" value="" id="{{ col.id }}"
              name="{{ col.id }}" size="{{ col.width }}">
      </td>
      {% end %}
      {% end %}
    </tr>
  </table>
  {% if table %}
  <input type="hidden" name="n_rows" value="{{ i_row+1 }}">
  {% else %}
  <input type="hidden" name="n_rows" value="0">
  {% end %}
  </div>
  <button name="save" value="save" type="submit"  class="btn btn-success">
    <span class="glyphicon glyphicon-save"></span>
    Save
  </button>
  <button name="clear" value="clear" type="submit"  class="btn btn-success">
    <span class="glyphicon glyphicon-save"></span>
    Clear
  </button>
  </form>
  </div>
</div>
{% end %} {# block main_content #}
