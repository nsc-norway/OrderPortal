{# Sample table page. #}

{% block head_title %}Samples for order '{{ order['title'] }}'{% end %}
{% block body_title %}Samples for order: {{ order['title'] }}{% end %}

{% extends "base.html" %}

{% block header_css %}
<link rel="stylesheet" href="{{ static_url('nsc_style.css') }}">
{% end %}

{% block body_header_meta %}
<a href="{{ reverse_url('order_api', order['_id']) }}">
  {% module Icon('json') %} JSON
</a>
{% end %}

{% block meta_content %}
<p>
  <form action="{{ reverse_url('order', order['_id']) }}"
	role="form"	method="GET">
    <input type="hidden" name="_http_method" value="delete">
    <button type="submit" class="btn btn-danger btn-block">
      <span class="glyphicon glyphicon-trash"></span>
      Cancel
    </button>
  </form>
</p>

<br>
<br>

<p>
  {% if valid %}
  <form action="{{ reverse_url('order', order['_id']) }}"
    	role="form"
    	method="POST">
    {% module xsrf_form_html() %}
    <p>
      <button type="submit" name="submit" class="btn btn-lg btn-success btn-block">
        <span class="glyphicon glyphicon-trash"></span>
        Save
      </button>
    </p>
  </form>
  {% else %}
  <div class="well well-lg text-danger">
    Upload a valid sample table to save.
  </div>
  {% end %} {# if targets #}
</p>
{% end %} {# block meta_content #}

{% block main_content %}
<div class="panel panel-default">
  <div class="panel-body">
  <p>To enter sample information:
    <ul>
      <li>Download the
    <a href="https://portal.sequencing.uio.no/file/Sample%20table/download">sample table template</a></li>
    <li>Fill in information about your samples and save it</li>
    <li>Upload it in the form below</li>
    <li>Verify the output and click Save on the right</li>
  </ul>
  </p>


  {% if valid %}
  <p>
    Please confirm that the sample information has been imported correctly, by inspecting the table below.
    If there is an error, contact us at <a href="mailto:post@sequencing.uio.no">post@sequencing.uio.no</a>.
  </p>
  {% else %}
  <p>
  </p>
  {% end %}

  <form action="{{ reverse_url('nsc_order_samples', order['_id']) }}"
        role="form"
        enctype="multipart/form-data"
        method="POST">
    {% module xsrf_form_html() %}
    <label for="file">Sample table (Spreadsheet: Excel or CSV)</label>
    <div style="clear: both;"></div>
    <div class="form-group upload-box">
      <input type="file" name="file" class="form-control">
      <span class="help-block">
        The sample table to upload.
      </span>
    </div>

    <div class="form-group upload-btn-box">
      <label class="control-label"></label>
      <button type="submit" class="btn btn-success">
        <span class="glyphicon glyphicon-floppy-disk"></span>
        Upload
      </button>
    </div>
  </form>
  <div style="clear: both;"></div>

  <h3>Sample information ({{ len(table) }} samples)</h3>
  <form action="{{ reverse_url('nsc_order_samples', order['_id']) }}"
        fole="form"
        method="POST">
  <div class="the-grid">
  {% module xsrf_form_html() %}

  <table class="sample-list">
    <tr>
      {% for col in columns %}
      <th>
        {{ col.label }}
      </th>
      {% end %}
      <th></th>
    </tr>
    {% for i_row, row in enumerate(table) %}
    <tr>
      {% for cell in row %}
      <td {{ 'class="validation-error"' if not cell.valid else '' }}>
        <input type="text" name="{{ cell.id + str(i_row) }}"
                size="{{ cell.width }}" value="{{ cell.value }}">
        {% if not cell.valid %}
        <hr><div class="error-message">{{ cell.message }}</div>
        {% end %}
      </td>
      {% end %}
      <td></td>
    </tr>
    {% end %}
    <tr>
      {% for col in columns %}
      {% if col.id == 'sample_number' %}
      <td class="input"></td>
      {% else %}
      <td class="input">
        <input type="text" value="" id="{{ col.id }}" name="{{ col.id }}" size="{{ col.width }}">
      </td>
      {% end %}
      {% end %}
      <td class="input">
        <button type="submit" class="btn btn-success" name="add-sample">
          <span class="glyphicon glyphicon-plus"></span>
          Add
        </button>
      </td>
    </tr>
  </table>
  </div>
  <button name="save" type="submit"  class="btn btn-success">
    <span class="glyphicon glyphicon-save"></span>
    Save
  </button>
  </form>
  </div>
</div>
{% end %} {# block main_content #}
