{# Order edit page. #}

{% extends "base.html" %}

{% block head_title %}Edit order '{{ order['title'] }}'{% end %}
{% block body_title %} Edit order '{{ order['title'] }}'{% end %}

{% block content %}
<h3>{{ form['title'] }}</h3>

<div class="row">
  <div class="col-md-10">
    <span class="help-block">
      You may save incomplete orders. However, partially filled-in
      orders cannot be submitted.
    </span>
  </div>
  <div class="col-md-2">
    <form action="{{ reverse_url('order', order['_id']) }}"
	  class="myForm"
	  role="form"
	  method="GET">
      <div class="form-group">
	<button type="submit" class="btn btn-default btn-block">
	  <span class="glyphicon glyphicon-remove"></span>
	  Cancel edit
	</button>
      </div>
    </form>
  </div>
</div>

<form action="{{ reverse_url('order_edit', order['_id']) }}"
      class="myForm"
      role="form"
      method="POST">
  {% module xsrf_form_html() %}

  {% include 'order_edit_save.html' %}

  <div class="form-group">
    <div class="row">
      <div class="col-md-9">
	<label class="control-label" for="__title__">Title</label>
	<input type="text" class="form-control"
	       name="__title__" id="__title__"
	       value="{{ order['title'] }}">
      </div>
    </div>
    <span class="help-block">
      Brief, descriptive title for the order. It is not required to
      be unique, but it is a good idea to make it so anyway.
    </span>
  </div>

  <div class="form-group">
    <div class="row">
      <div class="col-md-9">
	<label class="control-label" for="__tags__">Tags</label>
	{% if is_staff %}
	{% set tags = order.get('tags', []) %}
	{% else %}
	{% set tags = [t for t in order.get('tags', []) if not ':' in t] %}
	{% end %}
	<textarea class="form-control"
		  name="__tags__" id="__tags__" rows="2"
		  >{{ ', '.join(tags) }}</textarea>
      </div>
    </div>
    <span class="help-block">
      Tags characterizing the order. Must be formatted as identifiers,
      i.e. start with a letter, continue with letters, digits and/or
      underscore; no blanks allowed.
      {% if is_staff %}
      Staff may use namespace prefixes, e.g. "project_id:P12345".
      {% end %}
      More than one tag is allowed using comma ',' as delimiter.
    </span>
  </div>

  <div class="form-group">
    <div class="row">
      <div class="col-md-9">
	<label class="control-label" for="__owner__">Owner</label>
	{% if is_admin %}
	<input type="text" class="form-control"
	       name="__owner__" id="__owner__"
	       value="{{ order['owner'] }}">
	{% else %}
	<select class="form-control" name="__owner__" id="__owner__">
	  {% for colleague in colleagues %}
	    {% set sel = colleague == current_user['email'] and 'selected' or '' %}
	    <option {{ sel }}>{{ colleague }}</option>
	  {% end %}
	</select>
	{% end %}
      </div>
    </div>
    <span class="help-block">
      {% if is_admin %}
      The order's owner specified by email address. May be changed to
      another account.
      {% else %}
      The order's owner may be changed to an account in your groups.
      <strong>NOTE:</strong>
      You will then no longer be able to edit the order.
      {% end %}
    </span>
  </div>

  {# Recursion: 'include' cannot be used! #}
  {% module Template('order_edit_fields.html', fields=fields, order=order, is_staff=is_staff) %}

  {% include 'order_edit_save.html' %}
</form>
{% end %} {# block content #}

{% block javascript_code %}
<script src="{{ static_url('field_visible_if.js') }}"></script>
<script src="{{ static_url('quit_through_submit.js') }}"></script>
{% end %}

{% block javascript_autofocus %}
<script>
  $(document).ready(function(){
    $("#__title__").focus();
  });
</script>
{% end %}
