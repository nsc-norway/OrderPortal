{# Order page. #}

{% block head_title %}Order: {{ order['title'] }}{% end %}

{% block body_title %}
{% module Icon('order', label=True) %}: {{ order['title'] }}
{% end %}

{% extends "base.html" %}

{% block body_header_meta %}
<a href="{{ reverse_url('order_api', order['_id']) }}">
  {% module Icon('json') %} JSON
</a>
<a href="{{ reverse_url('order_api', order['_id']) }}?full=true">
  {% module Icon('json') %} Export
</a>
{% end %}

{% block meta_content %}

{% if is_editable %}
<p>
  <form action="{{ reverse_url('order_edit', order['_id']) }}"
	role="form"
	method="GET">
    <button type="submit" class="btn btn-lg btn-primary btn-block">
      <span class="glyphicon glyphicon-edit"></span>
      Edit
    </button>
  </form>
</p>
<p>
  <form action="{{ reverse_url('order', order['_id']) }}"
	role="form"
	method="POST">
    {% module xsrf_form_html() %}
    <input type="hidden" name="_http_method" value="delete">
    <button type="submit" class="btn btn-danger btn-block"
	    onclick="return confirm('Cannot be undone! Really delete?');">
      <span class="glyphicon glyphicon-trash"></span>
      Delete
    </button>
  </form>
</p>
{% elif not global_modes['allow_order_editing'] %}
<p>
  <div class="well text-danger">
    Order editing is currently disabled.
  </div>
</p>
{% end %} {# if is_editable #}

{% if is_clonable %}
<p>
  <form action="{{ reverse_url('order_clone', order['_id']) }}"
	role="form"
	method="POST">
    {% module xsrf_form_html() %}
    <button type="submit" class="btn btn-primary btn-block">
      <span class="glyphicon glyphicon-plus-sign"></span>
      Clone
    </button>
  </form>
</p>
{% elif not global_modes['allow_order_creation'] %}
<p>
  <div class="well text-danger">
    Order creation is currently disabled.
  </div>
</p>
{% else %}
<p>
  <div class="well">
    This order cannot be cloned.
  </div>
<p>
{% end %} {# if is_clonable #}

<br>
<br>

<p>
  {% if targets %}
  {% for target in targets %}
  <form action="{{ reverse_url('order_transition', order['_id'], target['identifier']) }}"
	role="form"
	method="POST">
    {% module xsrf_form_html() %}
    <p>
      <button type="submit" class="btn btn-lg btn-success btn-block"
	      {% if not is_admin %}
	      onclick="return confirm('Cannot be undone! Really change status?');"
	      {% end %}
	      >
	{% module Icon(target['identifier']) %}
	{{ target.get('action', target['identifier']) }}
      </button>
    </p>
  </form>
  {% end %} {# for target in targets #}
  {% else %}
  {% if order['invalid'] %}
  <div class="well well-lg text-danger">
    Order cannot be submitted due to invalid or missing values.
  </div>
  {% end %}
  {% end %} {# if targets #}
</p>
{% end %} {# block meta_content #}

{% block main_content %}
<div class="panel panel-default">
  <div class="panel-body">
    <h3 style="padding-left: 4em;">{{ form['title'] }}</h3>
    <table class="table table-condensed table-fields table-noborder">
      {% if settings.get('ORDER_IDENTIFIER_FORMAT') %}
      <tr>
	<th>Identifier</th>
	<td colspan="2">{{ order.get('identifier') or '-' }}</td>
      </tr>
      {% end %} {# if settings.get('ORDER_IDENTIFIER_FORMAT') #}

      {% if is_admin %}
      <tr>
	<th>Order form</th>
	<td>
	  <a href="{{ reverse_url('form', form['_id']) }}">
	    {{ form['title'] }}
	    ({{ form.get('version') or '-' }})
	  </a>
	</td>
      </tr>
      {% end %}

      <tr>
	<th>Owner</th>
	<td colspan="2">
	  <a href="{{ reverse_url('account', order['owner']) }}">
	    {{ account_names.get(order['owner'], order['owner']) }}
	  </a>
	</td>
      </tr>
      <tr>
	<th>Status</th>
	<td>
	  {% module Icon(order['status'], label=True) %}
	  ({{ status['description'] }})
	</td>
      </tr>
      <tr>
	<th>Tags</th>
	<td>
	  {% set tags = order.get('tags', []) %}
	  {% for tag in tags %}
	  <a href="{{ reverse_url('search', term=tag) }}">{{ tag }}</a>{{ tag != tags[-1] and ',' or '' }}
	  {% end %}
	</td>
      </tr>
      <tr>
	<th>History</th>
	<td>
	  <table>
	  {% for st, date in sorted(order['history'].items(), lambda i,j: cmp(j[1], i[1])) %}
	  <tr>
	    <td>{% module Icon(st, label=True) %}</td>
	    <td>&nbsp;{{ date }}</td>
	  <tr>
	  {% end %}
	  </table>
	</td>
      </tr>
      <tr>
	<th>Modified</th>
	<td>
	  <span class="localtime">{{ order['modified'] }}</span>
	  <a href="{{ reverse_url('order_logs', order['_id']) }}">
	    {% module Icon('logs', label=True) %}
	  </a>
	</td>
      </tr>
      <tr>
	<th>Created</th>
	<td class="localtime">{{ order['created'] }}</td>
      </tr>
      <tr>
	<th>IUID</th>
	<td>{{ order['_id'] }}</td>
      </tr>
      <tr>
	<th>Samples</th>
	<td>{{ 'No' if not samples else len(samples) }} samples -
    {% if order.get('samples_valid') %}
      <span class="text-success">
        <span class="glyphicon glyphicon-ok"></span>
        OK</span>
    {% else %}
      <span class="text-danger">
        <span class="glyphicon glyphicon-remove"></span>
        Incomplete information</span>
    {% end %}
    {% if is_editable %}
    <div>
      <a href="{{ reverse_url('nsc_order_samples', order['_id']) }}">
        View/edit sample information...
      </a>
    </div>
    {% end %}
  </td>
      </tr>

      <tr>
	<th>Files</th>
	<td colspan="2">
	  <table class="table table-condensed table-striped">
	    {% for file in attached_files %}
	    <tr>
	      <td>
		<a href="{{ reverse_url('order_file', order['_id'], file['filename']) }}">
		  {{ file['filename'] }}
		</a>
	      </td>
	      <td>{{ file['content_type'] }}</td>
	      <td>{{ int(0.5 + file['size'] / 1000.0) }} kB</td>
	      <td>
		<form action="{{ reverse_url('order_file', order['_id'], file['filename']) }}"
		      role="form"
		      method="POST">
		  {% module xsrf_form_html() %}
		  <input type="hidden" name="_http_method" value="delete">
		  <button type="submit" class="btn btn-danger btn-xs"
			  onclick="return confirm('Cannot be undone! Really delete?');">
		    <span class="glyphicon glyphicon-trash"></span>
		    Delete
		  </button>
		</form>
	      </td>
	    </tr>
	    {% end %}
	  </table>
	  {% if is_attachable %}
	  <button type="button" class="btn btn-primary"
		  data-toggle="modal" data-target="#attach">
	    <span class="glyphicon glyphicon-paperclip"></span>
	    Attach
	  </button>
	  {% end %}
	</td>
      </tr>
    </table>
  </div>
</div>

<table class="table table-condensed table-noborder table-hierarchy">
{# Recursion: 'include' cannot be used! #}
{% module Template('order_fields.html', fields=fields, order=order, is_staff=is_staff) %}
</table>

{% if is_attachable %}
{# Modal for attaching a file. #}
<div id="attach" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">

    {# Modal content #}
    <div class="modal-content">
      <div class="modal-header">
	<button type="button" class="close"
		data-dismiss="modal" aria-label="Close">
	  <span aria-hidden="true">&times;</span>
	</button>
        <h4 class="modal-title">Attach a file</h4>
      </div>
      <div class="modal-body">
	<form action="{{ reverse_url('order_attach', order['_id']) }}"
	      role="form"
	      enctype="multipart/form-data"
	      method="POST">
	  {% module xsrf_form_html() %}
	  <div class="form-group">
	    <label for="file">File</label>
	    <input type="file" name="file" class="form-control">
	    <span class="help-block">
	      The file to upload and attach to the order.
	    </span>
	  </div>

	  <div class="form-group">
	    <label class="control-label"></label>
	    <button type="submit" class="btn btn-success">
	      <span class="glyphicon glyphicon-floppy-disk"></span>
	      Save
	    </button>
	  </div>
	</form>
      </div>
    </div>

  </div>
</div>
{% end %}{# if is_attachable #}

{% end %} {# block main_content #}
