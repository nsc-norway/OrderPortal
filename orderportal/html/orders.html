{# List of all orders; for staff. #}

{% extends "base.html" %}

{% block head_title %}{{ term('Orders') }}{% end %}
{% block body_title %}
{% module Icon('order', title='Orders', label=True) %}
{% end %}

{% block header_css %}
<link rel="stylesheet" type="text/css"
      href="{{ settings['DATATABLES_CSS_URL'] }}">
{% end %}

{% block body_header_meta %}
<a href="{{ reverse_url('orders_api', **params) }}">
  {% module Icon('json') %} JSON
</a>
{% end %}

{% block container %}
<div class="container-fluid">
{% end %}

{% block content %}
<div class="row">
  <div class="col-md-7 col-md-offset-3">
    <form action="{{ reverse_url('orders', **params) }}"
	  id="refresh"
	  role="form"
	  class="form-inline"
	  method="GET">
      <span class="glyphicon glyphicon-filter"></span>
      <div class="form-group">
	<label for="form_title">Filter by</label>
	<select name="form_title" id="form_title" class="form-control refresh">
	  <option value="">[any form]</option>
	  {% for title in form_titles %}
	  {% set sel = title == params.get('form_title') and 'selected' or '' %}
	  <option {{ sel }}>{{ title }}</option>
	  {% end %}
	</select>
      </div>
      {% for f in settings['ORDERS_LIST_FIELDS'] %}
      <div class="form-group">
	<select name="{{ f['identifier'] }}" class="form-control refresh">
	  <option value="">[any {{ f['identifier'].replace('_', ' ') }}]</option>
	  {% for v in f['values'] %}
	  {% set sel = v == params.get(f['identifier']) and 'selected' or '' %}
	  <option {{ sel }} value="{{ v }}">{{ v }}</option>
	  {% end %}
	  {% set sel = '__none__' == params.get(f['identifier']) and 'selected' or '' %}
	  <option {{ sel }} value="__none__">[none]</option>
	</select>
      </div>
      {% end %} {# for f in settings['ORDERS_LIST_FIELDS'] #}
      <div class="form-group">
	<select name="status" class="form-control refresh">
	  <option value="">[any status]</option>
	  {% for s in settings['ORDER_STATUSES'] %}
	  {% set sid = s['identifier'] %}
	  {% set sel = sid == params.get('status') and 'selected' or '' %}
	  <option {{ sel }} value="{{ sid }}">{{ sid.capitalize() }}</option>
	  {% end %}
	</select>
      </div>
      {% if settings['DISPLAY_ORDERS_MOST_RECENT'] > 0 %}
      <div class="form-group">
	<div class="control-label refresh" for="recent">
	  &nbsp;
	  <label class="radio">
	    {% set checked = not params.get('recent', False) and 'checked' or '' %}
	    <input type="radio" name="recent" value="false" {{ checked }}>
	    All
	  </label>
	  <label class="radio">
	    {% set checked = not checked and 'checked' or '' %}
	    <input type="radio" name="recent" value="true" {{ checked }}>
	    Only {{ settings['DISPLAY_ORDERS_MOST_RECENT'] }} most recent
	  </label>
	</div>
      </div>
      {% end %} {# if settings['DISPLAY_ORDERS_MOST_RECENT'] > 0 #}
    </form>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <table id="orders"
	   class="table table-striped table-condensed"
	   data-page-length="25">
      <thead>
	<tr>
	  <th>{% module Icon('order', label=True) %}</th>
	  <th width="20%">Title</th>
	  <th>{% module Icon('form', label=True) %}</th>
	  <th>{% module Icon('account', label=True, title='Owner') %}</th>
	  {% if settings['ORDERS_LIST_TAGS'] %}
	  <th width="5%">Tags</th>
	  {% end %} {# if settings['ORDERS_LIST_TAGS'] #}
	  {% for f in settings['ORDERS_LIST_FIELDS'] %}
	  <th>{{ f['identifier'].capitalize().replace('_', ' ') }}</th>
	  {% end %}
	  <th>Status</th>
	  {% for s in settings['ORDERS_LIST_STATUSES'] %}
	  <th>{% module Icon(s, label=True) %}</th>
	  {% end %}
	  <th>Modified</th>
	</tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
{% end %} {# block content #}

{% block javascript_code %}
{% import json %}
<script src="{{ settings['DATATABLES_JS_URL'] }}"></script>
<script src="{{ settings['DATATABLES_BOOTSTRAP_JS_URL'] }}"></script>
<script>
$(document).ready(function() {
  $(".refresh").change(function () {
    $("#refresh").submit();
  });
  $("#orders").DataTable( {
    pagingType: "full_numbers",
    order: [[{{ order_column }}, "desc"]],
    ajax: {
      url: "/api/v1/orders",
      dataSrc: "items",
      data: {% raw json.dumps(params) %}
    },
    columns: [
      {data: "name",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.links.display.href+"'>"+oData.name+"</a>");
       }
      },
      {data: "title",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).text(oData.title); // escapes dangerous chars
       }
      },
      {data: "form",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.form.links.display.href+"'>"+oData.form.title+"</a>");
       }
      },
      {data: "owner",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.owner.links.display.href+"'>"+oData.owner.name+"</a>");
       }
      },
      {% if settings['ORDERS_LIST_TAGS'] %}
      {data: "tags",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).text(oData.tags.join(", "));
       }
      },
      {% end %} {# if settings['ORDERS_LIST_TAGS'] #}
      {% for f in settings['ORDERS_LIST_FIELDS'] %}
        { data: "fields.{{ f['identifier'] }}" },
      {% end %}
      {data: "status",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<img src='"+oData.status.display.href+"'> "+oData.status.name);
       }
      },
      {% for s in settings['ORDERS_LIST_STATUSES'] %}
        {data: "history.{{ s }}"},
      {% end %}
      {data: "modified",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html($.localtime.toLocalTime(oData.modified));
       }
      }
    ]
  });
});
</script>
{% end %} {# block javascript_code #}
