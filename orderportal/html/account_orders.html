{# List of all orders for an account. #}

{% extends "base.html" %}

{% block head_title %}{{ term('Orders') }} {{ account['email'] }}{% end %}

{% block body_title %}
{% module Icon('order', title='Orders', label=True) %}
{% module Entity(account) %}
{% end %}

{% block header_css %}
<link rel="stylesheet" type="text/css"
      href="{{ settings['DATATABLES_CSS_URL'] }}">
{% end %}

{% block body_header_meta %}
<a href="{{ reverse_url('account_orders_api', account['email']) }}">
  {% module Icon('json') %} JSON
</a>
{% end %}

{% block container %}
<div class="container-fluid">
{% end %}

{% block content %}

<div class="row">
  <div class="col-md-4 col-md-offset-6">
    {% if any_groups and is_staff or account['email'] == current_user['email'] %}
    <a href="{{ reverse_url('account_groups_orders', account['email']) }}">
      {% module Icon('group') %}
      All {{ term('orders') }} in account's groups
    </a>
    {% end %}
  </div>
</div>

<br>

<div class="row">
  <div class="col-md-12">
    <table id="orders"
	   class="table table-striped table-condensed"
	   data-page-length="25">
      <thead>
	<tr>
	  <th>{% module Icon('order', label=True) %}</th>
	  <th width="30%">Title</th>
	  {% if is_staff %}
	  <th>{% module Icon('form', label=True) %}</th>
	  {% end %} {# if is_staff #}
	  {% if settings['ORDERS_LIST_TAGS'] %}
	  <th width="5%">Tags</th>
	  {% end %} {# if settings['ORDERS_LIST_TAGS'] #}
	  {% for f in settings['ORDERS_LIST_FIELDS'] %}
	  <th>{{ f['identifier'].capitalize().replace('_', ' ') }}</th>
	  {% end %}
	  <th>Status</th>
	  {% for s in settings['ORDERS_LIST_STATUSES'] %}
	  <th>{% module Icon(s, label=True) %}</th>
	  {% end %}
	  <th>Modified</th>
	</tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
{% end %} {# block content #}

{% block javascript_code %}
<script>
$(document).ready(function() {
    $('.refresh').change(function () {
	$('#refresh').submit();
    });
});
</script>
{% end %}

{% block javascript_code %}
<script src="{{ settings['DATATABLES_JS_URL'] }}"></script>
<script src="{{ settings['DATATABLES_BOOTSTRAP_JS_URL'] }}"></script>
<script>
$(document).ready(function() {
  $(".refresh").change(function () {
    $("#refresh").submit();
  });
  $("#orders").DataTable( {
    pagingType: "full_numbers",
    order: [[{{ order_column }}, "desc"]],
    ajax: {
      url: "/api/v1/account/{{ account['email']}}/orders",
      dataSrc: "items"
    },
    columns: [
      {data: "name",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.links.display.href+"'>"+oData.name+"</a>");
       }
      },
      {data: "title",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).text(oData.title); // escapes dangerous chars
       }
      },
      {% if is_staff %}
      {data: "form",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.form.links.display.href+"'>"+oData.form.title+"</a>");
       }
      },
      {% end %} {# if is_staff #}
      {% if settings['ORDERS_LIST_TAGS'] %}
      {data: "tags",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).text(oData.tags.join(", "));
       }
      },
      {% end %} {# if settings['ORDERS_LIST_TAGS'] #}
      {% for f in settings['ORDERS_LIST_FIELDS'] %}
        {data: "fields.{{ f['identifier'] }}"},
      {% end %}
      {data: "status",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<img src='"+oData.status.display.href+"'> "+oData.status.name);
       }
      },
      {% for s in settings['ORDERS_LIST_STATUSES'] %}
        {data: "history.{{ s }}"},
      {% end %}
      {data: "modified",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html($.localtime.toLocalTime(oData.modified));
       }
      }
    ]
  });
});
</script>
{% end %} {# block javascript_code #}
